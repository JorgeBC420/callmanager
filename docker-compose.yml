version: '3.8'

services:
  # === SERVIDOR CALLMANAGER ===
  callmanager-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: callmanager-server
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - CALLMANAGER_HOST=0.0.0.0
      - CALLMANAGER_PORT=5000
      - PYTHONUNBUFFERED=1
    volumes:
      # Base de datos (persistente)
      - ./contacts.db:/app/contacts.db
      # Backups (persistente)
      - ./backups:/app/backups
      # Logs (persistente)
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - callmanager-network
    labels:
      - "com.callmanager.description=CallManager Server"
      - "com.callmanager.version=2.0"

  # === NGINX (Proxy inverso - Opcional pero recomendado) ===
  nginx:
    image: nginx:alpine
    container_name: callmanager-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - callmanager-server
    restart: unless-stopped
    networks:
      - callmanager-network
    labels:
      - "com.callmanager.description=NGINX Proxy"

volumes:
  # Volúmenes nombrados (más seguros que bind mounts)
  callmanager-data:
    driver: local
  callmanager-backups:
    driver: local

networks:
  callmanager-network:
    driver: bridge

# === INSTRUCCIONES DE USO ===
#
# 1. Construir imagen:
#    docker-compose build
#
# 2. Iniciar servicios:
#    docker-compose up -d
#
# 3. Ver logs:
#    docker-compose logs -f callmanager-server
#
# 4. Ejecutar migraciones:
#    docker-compose exec callmanager-server python scripts/migrate_db.py
#
# 5. Crear usuario admin:
#    docker-compose exec callmanager-server python scripts/init_users.py
#
# 6. Detener servicios:
#    docker-compose down
#
# 7. Limpiar todo (incluyendo volúmenes):
#    docker-compose down -v
